const webpack = require('webpack');
const path = require('path');
const fs = require('fs');
const devMiddleware = require('webpack-dev-middleware');
const hotMiddleware = require('webpack-hot-middleware');
const clientConfig = require('../build/webpack.dev.config');
const serverConfig = require('../build/webpack.server.js');
const MemoryFileSystem = require('memory-fs');
const chalk = require('chalk');
const chokidar = require('chokidar');

const readBuildFile = (fs, file) => {
    try {
        return fs.readFileSync(path.join(clientConfig.output.path, file), 'utf-8')
    } catch (e) {
        console.log(e);
    }
}


module.exports = function devServer (app, templatePath, updateBundleRenderer) {
    let readyResolve;
    let readyPromise = new Promise(resolve => {
        readyResolve = resolve;
    })
    let serverBundle;
    const renderOption = {
        runInNewContext: false
    };

    update = () => {
        if (serverBundle) {
            readyResolve();
            updateBundleRenderer(serverBundle, renderOption);
        }
    }

    // client bundle hot-reload
    const clientComplier = webpack(clientConfig);

    app.use(devMiddleware(clientComplier, {
        publicPath: clientConfig.output.publicPath,
        quiet: true
    }));

    app.use(hotMiddleware(clientComplier, {
        heartbeat: 2000
    }));

    clientComplier.plugin('done', stats => {
        console.log(chalk.green('[ webpack.dev.config.js ]: client complile done'));
        update();
    })

    // server bundle hot-reload
    const serverComplier = webpack(serverConfig);
    const mfs = new MemoryFileSystem();
    serverComplier.outputFileSystem = mfs;
    serverComplier.watch({}, (err, stats) => {
        if (err) throw err;
        stats = stats.toJson();
        if (stats.errors.length) return;
        console.log(chalk.green('[ webpack.server.js ]: server bundle update'));
        // read bundle generated by vue-ssr-webpack-plugin
        serverBundle = JSON.parse(readBuildFile(mfs, 'vue-ssr-server-bundle.json'))
        update();
    });

    // template hot-reload
    let template = fs.readFileSync(templatePath, 'utf-8');
    renderOption.template = template;
    chokidar.watch(templatePath).on('change', () => {
        template = fs.readFileSync(templatePath, 'utf-8');
        renderOption.template = template;
        console.log(chalk.green('[ chokidar watch ]: index.template.html updated'));
        update();
    })


    return readyPromise;
}